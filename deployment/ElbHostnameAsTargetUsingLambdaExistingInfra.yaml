AWSTemplateFormatVersion: '2010-09-09'

Description: >-
  This template creates AWS Lambda for configuring hostname as target for
  Elastic Load Balancer. Template creates following resources:
    - If CreateDstS3BucketCondition is set to Yes, creates new S3 bucket to be
    used as destination S3 bucket for ElbHostnameAsTarget.zip and for IP
    address updates. If set to No, uses existing S3 bucket. Existing S3 bucket
    should region and region from which you launch this CloudFormation should
    be the same
    - 2 Lambdas: S3ObjectLambda and ElbHostnameTarget
    - One Event Rule with Lambda Function as target
    - One Lambda Permission to invoke Event Rule
  
  Before you launch this template, make sure that you have a target group with 
  the type ip associated with a Elastic Load Balancer. Lambda created by the
  template is not configured to access resources in your VPC. If you plan to 
  use VPC .2 resolver as the DNS server, configure Lambda to access resources
  in your VPC.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: S3 Configuration 
        Parameters:
          - DstS3BucketName
          - CreateDstS3BucketCondition      
      - Label:
          default: 'User Configurable Lambda Environment Variables'
        Parameters:
          - ElbTargetGroupArn
          - TargetFQDN
          - DnsServers
          - MaxLookupPerInvocation
          - InvocationBeforeRegistration
          - ReportIpCountCwMetric
          - RemoveUntrackedTgIp

    ParameterLabels:
      DstS3BucketName:
        default: Destination S3 Bucket Name        
      CreateDstS3BucketCondition:
        default: Create S3 bucket condition
      ElbTargetGroupArn:
        default: ARN of Target Group assocated with desired Network Load Balancer
      TargetFQDN:
        default: Fully Qualified Domain Name (FQDN) used for managing your application cluster     
      DnsServers:
        default: The IP Address of DNS resolver/server(s) to query
      MaxLookupPerInvocation:
        default: The max times of DNS look per invocation
      InvocationBeforeRegistration:
        default: The number of required Invocations before a IP is deregistered
      ReportIpCountCwMetric:
        default: Enable/Disable Hostname IP count CloudWatch metric
      RemoveUntrackedTgIp:
        default: Remove IPs that were not added by the fucntion

Parameters:
  DstS3BucketName:
    Description: >- 
      Destination S3 bucket name. Required for this stack. If using existing
      bucket, set CreateDstS3BucketCondition to No, else set to Yes.
    Type: String
    ConstraintDescription: Must be globally unique S3 bucket name.  
  CreateDstS3BucketCondition: 
    Description: >- 
      Do you want to create new S3 bucket or use an existing one? If using
      existing bucket, verify launch stack region and bucket region are same.
    Default: "No"
    AllowedValues: ["Yes", "No"]
    Type: String
    ConstraintDescription: Must be a valid Yes or No option
  ElbTargetGroupArn:
    Description: >-
      Enter ARN of Target Group associated with desired Network Load Balancer
      Example: arn:aws:elasticloadbalancing:us-west-2:123456789012:targetgroup/my-targets/73e2d6bc24d8a067
    Type: String
    ConstraintDescription: Must be a valid Target Group ARN
  TargetFQDN:
    Description: Full Qualified Domain Name (FQDN) used for managing your application cluster
    Type: String
    ConstraintDescription: Must be a valid FQDN
  DnsServers:
    Description: >-
      DNS server to resolve TargetFQDN. Specify mulitple servers
      separted by ',': '10.10.10.10, 10.10.10.11'
    Type: String
    ConstraintDescription: 'Must be a valid string of DNS servers'
  MaxLookupPerInvocation:
    Description: >-
      The max times of DNS look per invocation
    Type: Number
    Default: 10
    ConstraintDescription: Must be a valid integer value
  InvocationBeforeRegistration:
    Description: >-
      The number of required Invocations before a IP is deregistered
    Type: Number
    Default: 3
    ConstraintDescription: 'Must be a valid integer value'
  ReportIpCountCwMetric:
    Description: >-
      Enable/Disable Hostname IP count CloudWatch metric
    Type: String
    Default: True
    AllowedValues: [True, False]
    ConstraintDescription: Must be True or False
  RemoveUntrackedTgIp:
    Description: >-
      Remove IPs that were not added by the fucntion
    Type: String
    Default: False
    AllowedValues: [True, False]
    ConstraintDescription: Must be True or False

Conditions:
  CreateDstS3Bucket: !Equals
    - !Ref CreateDstS3BucketCondition
    - "Yes"

Resources:
  S3BucketForLambda:
    Condition: CreateDstS3Bucket
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref DstS3BucketName
      Tags:
      - Key: Name
        Value: ElbLambdaSol-S3Bucket

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:ListAllMyBuckets
                  - s3:Get*
                  - s3:CreateBucket
                  - s3:ListBucket
                  - s3:DeleteObject
                  - cloudwatch:PutMetricData
                  - elasticloadbalancing:RegisterTargets
                  - elasticloadbalancing:Describe*
                  - elasticloadbalancing:DeregisterTargets                                             
                  - ssm:GetParameter
                Resource: "*"

  S3ObjectLambda:
    Type: AWS::Lambda::Function
    Properties:
      Handler: 'index.handler'
      Role: !GetAtt
        - LambdaExecutionRole
        - Arn
      Code:
        ZipFile: |
          import json
          import logging
          import sys

          import boto3
          import cfnresponse
          from botocore.exceptions import ClientError

          try:
              s3_resource = boto3.resource('s3')
              s3_client = boto3.client('s3')
          except ClientError as e:
              logger.error(f"ERROR: failed to connect to S3 resource or client: {e}")
              sys.exit(1)          

          def handler(event, context):
              logger = logging.getLogger()
              logger.setLevel(logging.INFO)
              logger.info("INFO: Received event: {}".format(json.dumps(event)))

              responseData = {}
              responseStatus = cfnresponse.FAILED

              print(event["ResourceProperties"])
              try:
                  src_s3 = event["ResourceProperties"]["SrcS3Bucket"]
                  dst_s3 = event["ResourceProperties"]["DstS3Bucket"]
                  obj_name = event["ResourceProperties"]["ObjName"]
                  aws_region = event["ResourceProperties"]["AwsRegion"]
              except Exception as e:
                  logger.error(f"parameter retival failure: {e}")
                  sys.exit(1)
              
              if isinstance(dst_s3, list):
                  dst_s3 = dst_s3[0]

              if event["RequestType"] == "Delete":            
                  s3_resource.Object(dst_s3, obj_name).delete()
                  responseStatus = cfnresponse.SUCCESS
                  cfnresponse.send(event, context, responseStatus, responseData)
              if event["RequestType"] == "Create":
                  logger.info(f"INFO: Copying {obj_name} from {src_s3} to {dst_s3}")
                  copy_source = {'Bucket': src_s3, 'Key': obj_name}
                  s3_resource.Object(dst_s3, obj_name).copy(copy_source)
                  responseStatus = cfnresponse.SUCCESS
                  cfnresponse.send(event, context, responseStatus, responseData)
      Runtime: python3.7
      Timeout: 45

  S3EditObject:
    Type: Custom::S3EditObject
    Properties:
      ServiceToken: !GetAtt S3ObjectLambda.Arn
      SrcS3Bucket: prm-demos-us-west-2
      DstS3Bucket: !If [CreateDstS3Bucket, !Ref S3BucketForLambda, !Ref DstS3BucketName]
      ObjName: ElbHostnameAsTarget.zip
      AwsRegion: !Ref AWS::Region

  ElbHostnameTarget:
    Type: AWS::Lambda::Function
    Properties:
      Handler: "elb_hostame_as_target.handler"
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !If [CreateDstS3Bucket, !Ref S3BucketForLambda, !Ref DstS3BucketName]
        S3Key: ElbHostnameAsTarget.zip
      Environment:
        Variables:
          TARGET_FQDN: !Ref TargetFQDN
          ELB_TG_ARN: !Ref ElbTargetGroupArn
          S3_BUCKET: !If [CreateDstS3Bucket, !Ref S3BucketForLambda, !Ref DstS3BucketName]
          DNS_SERVER: !Ref DnsServers
          BUCKET_REGION: !Ref AWS::Region
          MAX_LOOKUP_PER_INVOCATION: !Ref MaxLookupPerInvocation
          INVOCATIONS_BEFORE_DEREGISTRATION: !Ref InvocationBeforeRegistration
          REPORT_IP_COUNT_CW_METRIC: !Ref ReportIpCountCwMetric
          REMOVE_UNTRACKED_TG_IP: !Ref RemoveUntrackedTgIp
      Runtime: python3.7
      Timeout: 45

  LambdaEventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: ScheduledRule
      Name: ElbHostnameAsTargetEventbridgeTrigger
      ScheduleExpression: rate(3 minutes)
      State: ENABLED
      Targets:
        -
          Arn: !GetAtt ElbHostnameTarget.Arn
          Id: ElbHostnameTargetV1

  PermissionForEventsToInvokeLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ElbHostnameTarget
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt LambdaEventRule.Arn

Outputs:
  S3ObjectLambdaArn:
    Description: S3Object Lambda ARN
    Value: !GetAtt S3ObjectLambda.Arn
  ElbHostnameTargetArn:
    Description: ElbHostnameTarget Lambda ARN
    Value: !GetAtt ElbHostnameTarget.Arn
